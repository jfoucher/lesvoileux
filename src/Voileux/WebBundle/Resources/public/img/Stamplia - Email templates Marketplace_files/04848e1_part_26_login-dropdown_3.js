// Generated by CoffeeScript 1.4.0
(function() {

  App.View.LoginDropdown = App.View.extend({
    className: 'inner',
    templateName: 'login-dropdown',
    events: {
      'click .twitter': "twitterLogin",
      'click .facebook': 'facebookLogin',
      'submit .login': 'submit'
    },
    initialize: function() {
      var _this = this;
      return $(document).bind('openid_redirect', function(e, result) {
        return _this.redirected(result);
      });
    },
    render: function() {
      $(this.el).html(this.template());
      return this.el;
    },
    submit: function(e) {
      var _this = this;
      e.preventDefault();
      return App.client.login($('#emailLogin').val(), $('#passwordLogin').val(), $('#rememberLogin').val()).done(function(data) {
        $('html').trigger('click.dropdown');
        App.setPref('token', data.access_token);
        App.client.token = data.access_token;
        return App.init().done(function() {
          if (App.appData.beta) {
            return window.location = '/backend#dashboard';
          }
        });
      });
    },
    clearErrors: function() {
      $('ul.error').remove();
      return $('input.parsley-error').removeClass('parsley-error');
    },
    twitterLogin: function(e) {
      e.preventDefault();
      return window.open("/openid/login?client_id=" + (encodeURIComponent(App.client.client_id)) + "&stamplia_beta=1&openid_identifier=" + (encodeURIComponent('https://www.twitter.com')), "openidLogin" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
    },
    googleLogin: function(e) {
      e.preventDefault();
      return window.open("/openid/login?client_id=" + (encodeURIComponent(App.client.client_id)) + "&stamplia_beta=1&openid_identifier=" + (encodeURIComponent('https://www.google.com/accounts/o8/id')), "openidLogin" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
    },
    facebookLogin: function(e) {
      e.preventDefault();
      return window.open("/openid/login?client_id=" + (encodeURIComponent(App.client.client_id)) + "&stamplia_beta=1&openid_identifier=" + (encodeURIComponent('https://facebook.com')), "openidLogin" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
    },
    redirected: function(result) {
      var language_code, provider, _ref,
        _this = this;
      language_code = result.language_code || this.language || App.language || 'en';
      provider = ((_ref = result.external_identity) != null ? _ref.provider : void 0) || result.provider;
      if (result.success) {
        if (result.token) {
          App.client.token = result.token.access_token;
          App.setPref('token', result.token.access_token);
          return App.init().done(function(r) {
            $(document).trigger('login.success');
            if (window._gaq && provider) {
              return _gaq.push(['_trackPageview', "/user-created/" + language_code + "/" + (encodeURIComponent(provider))]);
            }
          });
        } else {
          if (window._gaq && provider) {
            return _gaq.push(['_trackPageview', "/user-confirm/" + language_code + "/" + (encodeURIComponent(provider))]);
          }
        }
      } else {
        this.clearErrors(this.el);
        if (result.error) {
          if (window._gaq) {
            _gaq.push(['_trackPageview', "/user-error/" + (encodeURIComponent(result.error))]);
          }
          return this.showErrors(result.error, $('#signup-social'));
        }
      }
    }
  });

}).call(this);
