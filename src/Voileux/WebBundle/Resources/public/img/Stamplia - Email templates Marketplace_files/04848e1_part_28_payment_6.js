// Generated by CoffeeScript 1.4.0
(function() {

  App.View.Payment = App.View.extend({
    tagName: 'div',
    id: 'my-shopping-cart',
    className: 'admin-module',
    templateName: 'payment',
    breadcrumbs: null,
    events: {
      'click .edit-info-button': "makeEditable",
      'click .save-info-button': "saveInfo",
      'submit .edit-info': "saveInfo",
      'click #main-payment': 'makePayment',
      'click #couponSubmit': 'applyCoupon',
      'click a.delete-template': 'removeTemplate'
    },
    initialize: function() {
      var _this = this;
      App.cartFetched.done(function() {
        return _this.render();
      });
      return $(document).on('paypal_redirect', function(e, data) {
        return _this.paypalRedirect(data);
      });
    },
    paypalRedirect: function(data) {
      var payment,
        _this = this;
      if (data.success) {
        payment = new App.Model.Payment;
        payment.set('invoice', data.invoice);
        this.showSuccess();
        return payment.fetch().done(function() {});
      } else {
        if (data.error === 'canceled') {
          return this.addError('Payment canceled', $('#main-payment'));
        }
      }
    },
    render: function() {
      $(this.el).html(this.template({
        model: App.cart
      }));
      App.setActive('templates');
      this.showCouponInfo();
      this.breadcrumbs = [
        {
          label: App.user.get('name'),
          link: '#dashboard'
        }, {
          label: 'My Templates'
        }
      ];
      App.setBreadcrumbs(this.breadcrumbs);
      this.accordion(500);
      App.resetHeight();
      return this.el;
    },
    applyCoupon: function(e) {
      var cart, code, res,
        _this = this;
      $('#couponSubmit').addClass('loading');
      e.preventDefault();
      code = $('#couponDisccount').val();
      cart = App.cart;
      cart.set({
        coupon: code
      });
      res = cart.save();
      res.done(function() {
        _this.showCouponInfo();
        $('#couponSubmit').removeClass('loading');
        return cart.fetch().done(function() {
          return $(".total i").html(cart.get('amount_with_tax') + '€');
        });
      });
      return res.fail(function() {
        _this.hideCouponMessage();
        return $('.discount p.error').html('The coupon code ' + code + ' does not correspond to any promotion').show();
      });
    },
    showCouponInfo: function() {
      var coupon, unit;
      this.hideCouponMessage();
      coupon = App.cart.get('coupon');
      if (coupon) {
        unit = "€";
        if (coupon.type === 1) {
          unit = "%";
        }
        $('.discount p.success').html('Coupon code ' + coupon.code + ' applied with ' + coupon.amount + ("" + unit + " discount")).show();
        return $('#coupon').hide();
      }
    },
    hideCouponMessage: function() {
      $('.discount p.success').hide();
      return $('.discount p.error').hide();
    },
    makePayment: function(e) {
      var purchase,
        _this = this;
      $('#main-payment').addClass('loading');
      e.preventDefault();
      purchase = new App.Model.Purchase;
      return purchase.save().done(function() {
        var payment;
        payment = new App.Model.Payment;
        payment.set('invoice', purchase.get('invoice'));
        payment.set('method', 'paypal_express_checkout');
        return payment.save().done(function(data) {
          $('#main-payment').removeClass('loading');
          if (data.redirect) {
            return window.open("/payment/redirect?r=" + (encodeURIComponent(data.redirect)), "paymentRedirect" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
          }
        });
      });
    },
    removeTemplate: function(e) {
      var $el, templateId, tmpls,
        _this = this;
      e.preventDefault();
      $el = $(e.currentTarget);
      templateId = $el.data('template-id');
      tmpls = _.reject(App.cart.get('templates'), function(tmpl) {
        return tmpl.id === templateId;
      });
      return App.cart.set('templates', tmpls).save().done(function() {
        return _this.render();
      });
    },
    makeEditable: function(e) {
      var btn, txt;
      e.preventDefault();
      btn = $(e.currentTarget);
      txt = btn.text();
      btn.removeClass('edit-info-button').addClass('save-info-button').text(btn.data('save-text'));
      btn.data('save-text', txt);
      this.$('form.edit-info').find('input').removeAttr('disabled');
      return App.resetHeight();
    },
    saveInfo: function(e) {
      var btn, data,
        _this = this;
      e.preventDefault();
      btn = $('#editInfoSubmit');
      btn.addClass('loading');
      data = {
        name: $('#accountManager').val(),
        company: $('#company').val(),
        address: $('#address').val(),
        zip: $('#zip').val(),
        city: $('#city').val(),
        country: $('#country').val()
      };
      App.user.set(data);
      return App.user.save().done(function() {
        var txt;
        txt = btn.text();
        btn.removeClass('save-info-button').removeClass('loading').addClass('edit-info-button').text(btn.data('save-text'));
        btn.data('save-text', txt);
        return _this.$('form.edit-info').find('input').attr('disabled', 'disabled');
      });
    },
    accordion: function(speed) {
      var _this = this;
      this.$(".accordion .inner-nav a").click(function(ev) {
        var el, item;
        ev.preventDefault();
        el = $(ev.currentTarget);
        el.parent().parent().parent().slideUp(speed);
        item = el.attr("href");
        $(item + ' .inside').slideDown(speed, function() {
          return App.resetHeight();
        });
        $(_this.el).scrollView(speed);
        return App.resetHeight();
      });
      this.$('.accordion .inside:eq(0)').show();
      return App.resetHeight();
    },
    addError: function(text, elem) {
      return elem.before('<ul class="error"><li class="error">' + text + '</li></ul>');
    },
    showSuccess: function() {
      this.$('.accordion').remove();
      return $('.admin-module').append('<p>Thank you for your payment</p>');
    }
  });

}).call(this);
