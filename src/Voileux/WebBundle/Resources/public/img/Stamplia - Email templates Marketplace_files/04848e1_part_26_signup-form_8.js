// Generated by CoffeeScript 1.4.0
(function() {

  App.View.SignupForm = App.View.extend({
    tagName: 'div',
    id: 'signup',
    templateName: 'signup-form',
    events: {
      'click .twitter': "twitterLogin",
      'click .facebook': 'facebookLogin',
      'click .google': 'googleLogin',
      'submit form.login': 'signup',
      'submit form.signup': 'subscribe',
      'click #signInSign': 'signup',
      'click #register-button': 'subscribe'
    },
    initialize: function() {
      var _this = this;
      $(document).off('openid_redirect');
      return $(document).bind('openid_redirect', function(e, result) {
        return _this.redirected(result);
      });
    },
    render: function() {
      $(this.el).html(this.template());
      $(this.el).css({
        'padding-top': 0,
        'margin-top': 0
      });
      $(this.el).find('form.login').parsley();
      return this.el;
    },
    subscribe: function(e) {
      var email, newsletter, params,
        _this = this;
      e.preventDefault();
      $('#register-button').addClass('loading');
      email = $('#register-email').val();
      params = {
        member: email,
        client_list: 1,
        name: $('#register-name').val()
      };
      newsletter = App.client.postJson('newsletter', params);
      newsletter.always(function() {
        return $('#newsSubscribe').removeClass('loading');
      });
      return newsletter.done(function() {
        $('.signup').hide();
        return $('.success').show();
      });
    },
    signup: function(e) {
      var email, name, options, password,
        _this = this;
      e.preventDefault();
      if (!$(this.el).find('form.login').parsley('validate')) {
        return false;
      }
      this.clearErrors();
      email = $('#email').val();
      password = $('#password').val();
      name = $('#name').val();
      options = {
        language_code: App.language
      };
      return App.client.createUser(name, email, password, options).done(function(data) {
        return setTimeout((function() {
          return App.client.login(email, password, 1).done(function(data) {
            App.setPref('token', data.access_token);
            App.client.token = data.access_token;
            return App.init().done(function() {
              var signedupView;
              if (App.appData.beta) {
                window.location = '/backend#dashboard';
              }
              signedupView = new App.View.SignedUp({
                model: App.user
              });
              $('#signup').html(signedupView.render());
              return $(document).trigger('login.success');
            });
          });
        }), 100);
      }).fail(function(xhr) {
        var result;
        result = JSON.parse(xhr.responseText);
        return _this.showErrors(result != null ? result.form : void 0, $(_this.el).find('form.login'));
      });
    },
    clearErrors: function() {
      $('ul.error').remove();
      return $('input.parsley-error').removeClass('parsley-error');
    },
    showErrors: function(error, form) {
      var err, name, value, _i, _len, _ref, _ref1, _results;
      form.prepend('<ul class="error parsley-error"></ul>');
      _ref = error != null ? error.errors : void 0;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        err = _ref[_i];
        form.find('ul.error').prepend('<li>' + err + '</li>');
      }
      _ref1 = error != null ? error.children : void 0;
      _results = [];
      for (name in _ref1) {
        value = _ref1[name];
        _results.push(form.find('#' + name).prepend('<li>' + value + '</li>'));
      }
      return _results;
    },
    twitterLogin: function(e) {
      e.preventDefault();
      return window.open("/openid/login?client_id=" + (encodeURIComponent(App.client.client_id)) + "&stamplia_beta=1&openid_identifier=" + (encodeURIComponent('https://www.twitter.com')), "openidLogin" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
    },
    googleLogin: function(e) {
      e.preventDefault();
      return window.open("/openid/login?client_id=" + (encodeURIComponent(App.client.client_id)) + "&stamplia_beta=1&openid_identifier=" + (encodeURIComponent('https://www.google.com/accounts/o8/id')), "openidLogin" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
    },
    facebookLogin: function(e) {
      e.preventDefault();
      return window.open("/openid/login?client_id=" + (encodeURIComponent(App.client.client_id)) + "&stamplia_beta=1&openid_identifier=" + (encodeURIComponent('https://facebook.com')), "openidLogin" + ((new Date).getTime()), "menubar=no,toolbar=no,location=no,status=no,width=800,height=600");
    },
    redirected: function(result) {
      var confirmView, language_code, provider, r, _ref,
        _this = this;
      language_code = result.language_code || this.language || App.language || 'en';
      provider = ((_ref = result.external_identity) != null ? _ref.provider : void 0) || result.provider;
      if (result.success) {
        if (result.token) {
          App.client.token = result.token.access_token;
          App.setPref('token', result.token.access_token);
          return App.init().done(function(r) {
            var signedupView;
            if (provider) {
              if (window._gaq) {
                _gaq.push(['_trackPageview', "/user-created/" + language_code + "/" + (encodeURIComponent(provider))]);
              }
              App.client.facebookTrack();
            }
            $(document).trigger('login.success');
            if (App.appData.beta) {
              window.location = '/backend#dashboard';
            }
            signedupView = new App.View.SignedUp({
              model: App.user
            });
            return $('#signup').html(signedupView.render());
          });
        } else {
          if (window._gaq) {
            _gaq.push(['_trackPageview', "/user-confirm/" + language_code + "/" + (encodeURIComponent(provider))]);
          }
          confirmView = new App.View.SignupConfirm({
            identity: result.external_identity
          });
          r = confirmView.render();
          return $('#signup').html(r);
        }
      } else {
        this.clearErrors(this.el);
        if (result.error) {
          if (window._gaq) {
            _gaq.push(['_trackPageview', "/user-error/" + (encodeURIComponent(result.error))]);
          }
          return this.showErrors(result.error, $('#signup-social'));
        }
      }
    }
  });

}).call(this);
